<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="com.irongteng.persistence.mapper.AreaAlarmMapper">
    
    <resultMap id="siteResult" type="Site">
        <result property="id" jdbcType="INTEGER" column="SiteID"/>
        <result property="siteName" jdbcType="VARCHAR" column="SiteName" />
        <result property="longitude" jdbcType="DOUBLE" column="Longitude" />
        <result property="latitude" jdbcType="DOUBLE" column="Latitude" />
        <result property="address" jdbcType="VARCHAR" column="Address" />
    </resultMap>
    <resultMap id="deviceResult" type="Device">
        <result property="id" jdbcType="INTEGER" column="DeviceID"/>
        <result property="deviceName" jdbcType="VARCHAR" column="DeviceName" />
        <association property="site" javaType="Site" column="SiteID" resultMap="siteResult" />
    </resultMap>
    
    <resultMap id="areaAlarmResult" type="AreaAlarm">
        <id property="id" jdbcType="INTEGER" column="ID" />
        <result property="areaContent" jdbcType="VARCHAR" column="AreaContent" />
        <result property="imsi" jdbcType="VARCHAR" column="IMSI" />
        <result property="recordTime" jdbcType="TIMESTAMP" column="RecordTime" />
        <result property="confirmTime" jdbcType="TIMESTAMP" column="ConfirmTime" />
        <association property="device" javaType="Device" column="DeviceID" resultMap="deviceResult" />
    </resultMap>
    
    <sql id="Base_Column_List">
        ma.ID as ID, ma.DeviceID, ma.AreaContent, ma.IMSI, ma.RecordTime, ma.ConfirmTime, d.DeviceName, d.SiteID, s.SiteName
    </sql>
    <!-- 查询指定ID内容 -->
    <select id="load" parameterType="Integer" resultMap="areaAlarmResult">
        SELECT 
            <include refid="Base_Column_List" />
        FROM t_area_alarm ma
            inner join device d on ma.DeviceID = d.id
            inner join t_site s on s.ID = d.siteID
        WHERE 
            ma.ID = #{id} 
    </select>
    <!-- 查询所有的ID -->
    <select id="findAllIds" resultType="Integer">
        SELECT ID FROM t_area_alarm
    </select>

    <!-- 按Id删除 -->
    <delete id="delete" parameterType="Integer">
        DELETE FROM t_area_alarm WHERE
        ID = #{id} 
    </delete>
     <!-- 插入 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id" parameterType="AreaAlarm">
        INSERT INTO t_area_alarm (
            DeviceID,
            AreaContent,
            IMSI,
            recordTime
        ) VALUES (
            #{device.id},
            #{areaContent},
            #{imsi},
            #{recordTime}
        )
    </insert>
    
    <!-- 批量添加 -->
    <insert id="addBatch" parameterType="java.util.List" >
        INSERT INTO t_area_alarm (DeviceID, AreaContent, IMSI, RecordTime)
        values  
        <foreach item="item" index="index" collection="list" separator="," >
            (#{item.device.id}, #{item.areaContent}, #{item.imsi}, #{item.recordTime}) 
        </foreach>
    </insert>
    
    <select id="countAll" resultType="Integer">
        SELECT count(0) FROM t_area_alarm    
    </select>
    
    <select id="findAll" resultMap="areaAlarmResult">
        SELECT 
            <include refid="Base_Column_List" />
        FROM t_area_alarm ma
            inner join device d on ma.DeviceID = d.id
            inner join t_site s on s.ID = d.siteID
    </select>
    <!-- 查询所有未确认告警 -->
    <select id="countAllAlarm" resultType="Integer">
        SELECT count(0) as c
        FROM t_area_alarm ma
            inner join device d on ma.DeviceID = d.id
            inner join t_site s on s.ID = d.siteID
        WHERE isnull(ma.ConfirmTime) is true
    </select>
    
    <!-- 查询所有未确认告警数目 -->
    <select id="findAllAlarm" resultMap="areaAlarmResult">
        SELECT 
            <include refid="Base_Column_List" />
        FROM t_area_alarm ma
            inner join device d on ma.DeviceID = d.id
            inner join t_site s on s.ID = d.siteID
        WHERE isnull(ma.ConfirmTime) is true
    </select>
    
    <!-- 查询所有未确认告警的设备ID -->
    <select id="findAllDeviceIDs" resultType="Integer">
        SELECT distinct ma.DeviceID
        FROM t_area_alarm ma
            inner join device d on ma.DeviceID = d.id
            inner join t_site s on s.ID = d.siteID
        WHERE isnull(ma.ConfirmTime) is true
    </select>
    
    <!-- 更新 -->
    <update id="updateSelective" parameterType="AreaAlarm">
        UPDATE t_area_alarm 
        <set>
            <if test="device!=null and device.id!=null">
            DeviceID = #{device.id},
            </if>
            <if test="areaContent!=null">
            AreaContent = #{areaContent},
            </if>
            <if test="imsi!=null">
            IMSI = #{imsi},
            </if>
            <if test="recordTime!=null">
            RecordTime = #{recordTime},
            </if>
            <if test="confirmTime!=null">
            ConfirmTime = #{confirmTime}
            </if>
        </set>
        WHERE 
            ID = #{id}
    </update>
    <!-- 更新 -->
    <update id="updateByDeviceID" parameterType="AreaAlarm">
        UPDATE t_area_alarm 
        <set>
            <if test="device!=null and device.id!=null">
            DeviceID = #{device.id},
            </if>
            <if test="areaContent!=null">
            AreaContent = #{areaContent},
            </if>
            <if test="recordTime!=null">
            RecordTime = #{recordTime},
            </if>
            <if test="confirmTime!=null">
            ConfirmTime = #{confirmTime}
            </if>
        </set>
        WHERE 
            DeviceID = #{device.id}
    </update>
    
    <update id="update" parameterType="AreaAlarm">
        UPDATE t_area_alarm 
        SET
            DeviceID = #{device.id},
            AreaContent = #{areaContent},
            IMSI = #{imsi},
            RecordTime = #{recordTime},
            ConfirmTime = #{confirmTime}
        WHERE 
            ID = #{id} 
    </update>
    
    <select id="findPageBreakByCondition" parameterType="map" resultMap="areaAlarmResult">
        select 
            <include refid="Base_Column_List" />
        from t_area_alarm ma
            inner join device d on ma.DeviceID = d.id
            inner join t_site s on s.ID = d.siteID
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <if test="siteID != null">
                AND s.ID in (#{siteID})
            </if>
            <if test="deviceID != null">
                AND d.ID in (#{deviceID})
            </if>
            <if test="status != null">
                AND d.ID in (#{status}) 
            </if>
            <if test="type != null">
                <choose>
                    <when test="type==1"><!-- 未确认告警 -->
                         AND  isnull(ma.ConfirmTime) is true
                    </when>
                    <otherwise><!-- 已确认告警 -->
                        AND  isnull(ma.ConfirmTime) is false
                    </otherwise>
                </choose>
            </if>
            <if test="startDate != null">
                AND ma.RecordTime &gt;= #{startDate} 
            </if>
            <if test="endDate != null">
                AND ma.RecordTime &lt;= #{endDate} 
            </if>
            <if test="keywords != null">
                AND (
                    ma.areaContent LIKE "%"#{keywords}"%"
                    or ma.IMSI LIKE "%"#{keywords}"%"
                )
              </if>
          </trim>
        
        <choose>
            <when test="orderField !=null and orderField !=''">
                 ORDER BY ${orderField} <if test="orderDirection != null and orderDirection != ''">${orderDirection}</if>
            </when>
            <otherwise>
                 order by ma.ID DESC
            </otherwise>
        </choose>
           
    </select>
    
    <select id="findNumberByCondition" resultType="Integer" parameterType="map">
        select count(ma.id) as c 
        from t_area_alarm ma
            inner join device d on ma.DeviceID = d.id
            inner join t_site s on s.ID = d.siteID
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <if test="siteID != null">
                AND s.ID in( #{siteID})
            </if>
            <if test="deviceID != null">
                AND d.ID in (#{deviceID})
            </if>
            <if test="status != null">
                AND d.ID in(#{status}) 
            </if>
            <if test="type != null">
                <choose>
                    <when test="type==1"><!-- 未确认告警 -->
                         AND isnull(ma.ConfirmTime) is true
                    </when>
                    <otherwise><!-- 已确认告警 -->
                        AND isnull(ma.ConfirmTime) is false
                    </otherwise>
                </choose>
            </if>
            <if test="startDate != null">
                AND ma.RecordTime &gt;= #{startDate} 
            </if>
            <if test="endDate != null">
                AND ma.RecordTime &lt;= #{endDate} 
            </if>
            <if test="keywords != null">
                AND (
                    ma.areaContent LIKE "%"#{keywords}"%"
                    or ma.IMSI LIKE "%"#{keywords}"%"
                )
              </if>
          </trim>

    </select>
    
    <select id="searchByDeviceID" parameterType="Integer" resultMap="areaAlarmResult">
        SELECT 
            <include refid="Base_Column_List" />
        FROM t_area_alarm ma
            inner join device d on ma.DeviceID = d.id
            inner join t_site s on s.ID = d.siteID
        WHERE
           d.ID=#{deviceID} and isnull(ma.ConfirmTime) is true
    </select>
    
    <select id="searchBySiteID" parameterType="Integer" resultMap="areaAlarmResult">
        SELECT 
            <include refid="Base_Column_List" />
        FROM t_area_alarm ma
            inner join device d on ma.DeviceID = d.id
            inner join t_site s on s.ID = d.siteID
        WHERE
           d.ID=#{siteID} and  isnull(ma.ConfirmTime) is true
    </select>
    
</mapper>

