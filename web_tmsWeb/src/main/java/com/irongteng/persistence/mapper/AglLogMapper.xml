<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.irongteng.persistence.mapper.AglLogMapper">
    
    <cache />
    
    <resultMap type="AglLog" id="aglLogResult">
        <id column="AglLogID" jdbcType="BIGINT" property="id" />
        <result property="deviceMac" jdbcType="VARCHAR"  column="Device_Mac"/>
        <result property="userMac" jdbcType="VARCHAR" column="User_Mac" />
        <result property="times" jdbcType="INTEGER" column="Times" />
        <result column="RecordTime" jdbcType="TIMESTAMP" property="recordTime" />
        <result property="appAgent" jdbcType="VARCHAR" column="App_Agent" />
        <result property="appQQ" jdbcType="VARCHAR" column="App_QQ" />
        <result property="appWebChar" jdbcType="VARCHAR" column="App_WebChar" />
        <association property="device" javaType="Device" column="DeviceID" resultMap="deviceResult" />
        <!-- <association property="monitor" javaType="Monitor" column="User_Mac" resultMap="monitorResult" /> -->
    </resultMap>
    <!--    
    <resultMap id="monitorResult" type="Monitor">
        <id property="id" jdbcType="INTEGER" column="MonitorID"/>
        <result property="name" jdbcType="VARCHAR" column="MonitorName" />
        <result property="mac" jdbcType="VARCHAR" column="User_MAC" />
        <result property="imei" jdbcType="VARCHAR" column="IMEI" />
        <result property="imsi" jdbcType="VARCHAR" column="IMSI" />
        <result property="remark" jdbcType="VARCHAR" column="Remark" />
    </resultMap>
    -->
    <!-- 设备信息表 -->
    <resultMap id="deviceResult" type="Device">
        <id property="id" jdbcType="INTEGER" column="DeviceID" />
        <result property="deviceName" jdbcType="VARCHAR" column="DeviceName" />
        <result property="deviceNumber" jdbcType="VARCHAR" column="DeviceNumber" />
        <result property="attachNumber" jdbcType="VARCHAR" column="AttachNumber" />
        <result property="commCategory" jdbcType="INTEGER" column="CommCategory" />
        <result property="ipAddress" jdbcType="VARCHAR" column="IpAddress" />
        <result property="port" jdbcType="INTEGER" column="Port" />
        <result property="status" jdbcType="INTEGER" column="Status" />
        <association property="site" javaType="Site" column="SiteID" resultMap="siteResult" />
    </resultMap>
    <resultMap id="siteResult" type="Site">
        <result property="id" jdbcType="INTEGER" column="SiteID"/>
        <result property="siteName" jdbcType="VARCHAR" column="SiteName" />
        <result property="longitude" jdbcType="DOUBLE" column="Longitude" />
        <result property="latitude" jdbcType="DOUBLE" column="Latitude" />
        <result property="address" jdbcType="VARCHAR" column="Address" />
    </resultMap>
    
    <sql id="Base_Column_List">
        d.SiteID, s.SiteName, a.DeviceID, d.DeviceName, a.id as AglLogID, a.Device_MAC,a.User_Mac, a.Times, a.RecordTime, a.App_Agent, a.App_QQ, a.App_WebChar
    </sql>
    
    <select id="load" parameterType="long" resultMap="aglLogResult">
        select 
            <include refid="Base_Column_List" /> 
        FROM agl_log a
            left join device d on d.ID=a.DeviceID 
            left join t_site s on s.ID=d.siteID 
        where a.ID = #{id}
    </select>
    
    <!-- 查询所有的ID -->
    <select id="findAllIds" resultType="Long">
        SELECT ID FROM agl_log
    </select>
    
    <select id="countAll" resultType="Long">
        SELECT count(ID) FROM agl_log    
    </select>
    
    <select id="findAll" resultMap="aglLogResult">
        SELECT 
            <include refid="Base_Column_List" />
        FROM agl_log a
            left join device d on d.ID=a.DeviceID 
            left join t_site s on s.ID=d.siteID 
    </select>
    
    <insert id="insert" parameterType="AglLog" useGeneratedKeys="true" keyProperty="id">
        insert into agl_log(DeviceID, Device_Mac, User_Mac, Times, RecordTime, App_Agent, App_QQ, App_WebChar)  
        values(#{device.id}, #{deviceMac}, #{userMac}, #{times}, #{recordTime}, #{appAgent}, #{appQQ}, #{appWebChar})
    </insert>
    
    <insert id="addBatch" parameterType="java.util.List" >
        insert into agl_log(
            DeviceID, 
            Device_Mac,
            User_Mac, 
            Times, 
            RecordTime, 
            App_Agent, 
            App_QQ, 
            App_WebChar
        ) values  
        <foreach item="item" index="index" collection="list" separator="," >
        (
            #{item.device.id}, 
            #{item.deviceMac},
            #{item.userMac},
            #{item.times},
            #{item.recordTime},
            #{item.appAgent},
            #{item.appQQ},
            #{item.appWebChar}
        ) 
        </foreach>
    </insert>
    
    <!-- 更新 -->
    <update id="updateSelective" parameterType="AglLog">
        UPDATE agl_log 
        <set>
            <if test="device!=null and device.id!=null">
            DeviceID=#{device.id},
            </if>
            <if test="deviceMac!=null">
            Device_Mac=#{deviceMac},
            </if>
            <if test="userMac!=null">
            User_Mac=#{userMac},
            </if>
            <if test="times!=null">
            Times=#{times},
            </if>
            <if test="recordTime!=null">
            RecordTime=#{recordTime},
            </if>
            <if test="appAgent!=null">
            App_Agent=#{appAgent},
            </if>
            <if test="appQQ!=null">
            App_QQ=#{appQQ},
            </if>
            <if test="appWebChar!=null">
            App_WebChar=#{appWebChar}
            </if>            
        </set>
        WHERE 
            ID = #{id}
    </update>
    
    <update id="update" parameterType="AglLog" >
        update agl_log set 
            <if test="device!=null and device.id!=null">
            DeviceID=#{device.id},
            </if>
            Device_Mac=#{deviceMac},
            User_Mac=#{userMac},
            Times=#{times},
            RecordTime=#{recordTime},
            App_Agent=#{appAgent},
            App_QQ=#{appQQ},
            App_WebChar=#{appWebChar}
         where ID=#{id}
    </update>
    
    <delete id="delete" parameterType="long">
        delete from agl_log where ID=#{id}
    </delete>
    
    <select id="findPageBreakByCondition" parameterType="map" resultMap="aglLogResult">
        SELECT 
            <include refid="Base_Column_List" />
        FROM agl_log a 
            left join device d on d.ID=a.DeviceID 
            left join t_site s on s.ID=d.siteID 
        
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <if test="siteID != null">
                AND s.ID in (#{siteID})
            </if>
            <if test="deviceID != null">
                AND d.ID in (#{deviceID})
            </if>
            <if test="status != null">
                AND a.User_Mac in(select MAC from monitor from where ID = #{status} 
            </if>
            <if test="startDate != null">
                AND a.RecordTime &gt;= #{startDate} 
            </if>
            <if test="endDate != null">
                AND a.RecordTime &lt;= #{endDate} 
            </if>
            <if test="keywords != null">
                AND ( s.SiteName LIKE "%"#{keywords}"%"
                    OR d.DeviceName LIKE "%"#{keywords}"%"
                    OR a.User_MAC LIKE "%"#{keywords}"%"
                )
            </if>
        </trim>
        <choose>
            <when test="orderField !=null and orderField !=''">
                ORDER BY ${orderField} <if test="orderDirection != null and orderDirection != ''">${orderDirection}</if>
            </when>
            <otherwise>
                order by a.ID DESC
            </otherwise>
        </choose>
    </select>
    
    <select id="findNumberByCondition" resultType="Integer" parameterType="map">
        SELECT count(a.ID) as c 
        FROM agl_log a 
            left join device d on d.ID=a.DeviceID 
            left join t_site s on s.ID=d.siteID 
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <if test="siteID != null">
                AND s.ID in (#{siteID})
            </if>
            <if test="deviceID != null">
                AND d.ID in (#{deviceID})
            </if>
            <if test="status != null">
                AND a.User_Mac in(select MAC from monitor from where ID = #{status} 
            </if>
            <if test="startDate != null">
                AND a.RecordTime &gt;= #{startDate} 
            </if>
            <if test="endDate != null">
                AND a.RecordTime &lt;= #{endDate} 
            </if>
            <if test="keywords != null">
                AND ( s.SiteName LIKE "%"#{keywords}"%"
                    OR d.DeviceName LIKE "%"#{keywords}"%"
                    OR a.User_MAC LIKE "%"#{keywords}"%"
                )
            </if>
        </trim>
    </select>
    
</mapper>