<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.irongteng.persistence.mapper.AplLogMapper">

    <cache />
    
    <resultMap type="AplLog" id="aplLogResult">
        <id column="AplLogID" jdbcType="BIGINT" property="id" />
        <result property="apMac" jdbcType="VARCHAR" column="AP_Mac" />
        <result property="apName" jdbcType="VARCHAR" column="AP_Name" />
        <result property="channel" jdbcType="INTEGER" column="Channel" />
        <result property="signalStrength" jdbcType="INTEGER" column="SignalStrength" />
        <result property="times" jdbcType="INTEGER" column="Times" />
        <result property="startTime" jdbcType="TIMESTAMP" column="StartTime" />
        <result property="endTime" jdbcType="TIMESTAMP" column="EndTime" />
        <result property="encrypt" jdbcType="VARCHAR" column="Encrypt" />
        <association property="device" javaType="Device" column="DeviceID" resultMap="deviceResult" />
    </resultMap>
    <!-- 设备信息表 -->
    <resultMap id="deviceResult" type="Device">
        <id property="id" jdbcType="INTEGER" column="DeviceID" />
        <result property="deviceName" jdbcType="VARCHAR" column="DeviceName" />
        <result property="deviceNumber" jdbcType="VARCHAR" column="DeviceNumber" />
        <result property="attachNumber" jdbcType="VARCHAR" column="Device_Mac" />
        <result property="commCategory" jdbcType="INTEGER" column="CommCategory" />
        <result property="ipAddress" jdbcType="VARCHAR" column="IpAddress" />
        <result property="port" jdbcType="INTEGER" column="Port" />
        <result property="status" jdbcType="INTEGER" column="Status" />
        <association property="site" javaType="Site" column="SiteID" resultMap="siteResult" />
    </resultMap>
    <resultMap id="siteResult" type="Site">
        <result property="id" jdbcType="INTEGER" column="SiteID"/>
        <result property="siteName" jdbcType="VARCHAR" column="SiteName" />
        <result property="longitude" jdbcType="DOUBLE" column="Longitude" />
        <result property="latitude" jdbcType="DOUBLE" column="Latitude" />
        <result property="address" jdbcType="VARCHAR" column="Address" />
    </resultMap>
    
    <sql id="Base_Column_List">
        a.ID as AplLogID,a.Device_MAC, a.AP_MAC, a.AP_Name, a.Channel, a.SignalStrength, a.Times, a.StartTime,  a.EndTime, a.Encrypt, 
            s.SiteName, d.SiteID, d.DeviceName, a.DeviceID
    </sql>
    
    <select id="load" parameterType="long" resultMap="aplLogResult">
        select 
            <include refid="Base_Column_List" />
        FROM apl_log a
            left join device d on d.ID=a.DeviceID 
            left join t_site s on s.ID=d.siteID 
        where a.ID = #{id}
    </select>
    
    <insert id="insert" parameterType="AplLog" useGeneratedKeys="true" keyProperty="id"> 
        insert into apl_log(DeviceID, Device_Mac, AP_Mac, AP_Name, Channel, SignalStrength, Times, StartTime, EndTime, Encrypt)  
        values(#{device.id}, #{deviceMac}, #{apMac}, #{apName}, #{channel}, #{signalStrength}, #{times}, #{startTime}, #{endTime}, #{encrypt})  
    </insert>
    
    <insert id="addBatch" parameterType="java.util.List">
        insert into apl_log(DeviceID, Device_Mac, AP_Mac, AP_Name, Channel, SignalStrength, Times, StartTime, EndTime, Encrypt)
        values  
        <foreach item="item" index="index" collection="list" separator=",">
            (#{item.device.id}, #{item.deviceMac}, #{item.apMac}, #{item.apName}, #{item.channel}, #{item.signalStrength}, #{item.times}, #{item.startTime}, #{item.endTime}, #{item.encrypt})
        </foreach>  
    </insert>
    
    <!-- 查询所有的ID -->
    <select id="findAllIds" resultType="Long">
        SELECT ID FROM apl_log
    </select>
    
    <select id="countAll" resultType="Long">
        SELECT count(0) FROM apl_log    
    </select>
    
    <select id="findAll" resultMap="aplLogResult">
        SELECT 
            <include refid="Base_Column_List" />
        FROM apl_log a
            left join device d on d.ID=a.DeviceID
            left join t_site s on s.ID=d.siteID
    </select>
    
    <!-- 更新 -->
    <update id="updateSelective" parameterType="AplLog">
        UPDATE apl_log 
        <set>
            <if test="device!=null and device.id!=null">
            DeviceID=#{device.id},
            </if>
            <if test="deviceMac!=null">
            Device_Mac=#{deviceMac},
            </if>
            <if test="apMac!=null">
            AP_Mac=#{apMac},
            </if>
            <if test="apName!=null">
            AP_Name=#{apName},
            </if>
            <if test="channel!=null">
            Channel=#{channel},
            </if>
            <if test="signalStrength!=null">
            SignalStrength=#{signalStrength},
            </if>
            <if test="times!=null">
            Times=#{times},
            </if>
            <if test="startTime!=null">
            StartTime=#{startTime},
            </if>
            <if test="endTime!=null">
            EndTime=#{endTime},
            </if>
            <if test="encrypt!=null">
            Encrypt=#{encrypt}
            </if>

        </set>
        WHERE 
            ID = #{id}
    </update>
    
    <update id="update" parameterType="AplLog" >
        update apl_log set 
            DeviceID=#{device.id},
            Device_Mac=#{deviceMac},
            AP_Mac=#{apMac},
            AP_Name=#{apName},
            Channel=#{channel},
            SignalStrength=#{signalStrength},
            Times=#{times},
            StartTime=#{startTime},
            EndTime=#{endTime},
            Encrypt=#{encrypt}
         where ID=#{id}
    </update>
    
    <delete id="delete" parameterType="long">
        delete from apl_log where ID=#{id}
    </delete>
    
    <select id="findPageBreakByCondition" parameterType="map" resultMap="aplLogResult">
        SELECT 
            <include refid="Base_Column_List" />
        FROM apl_log a
            left join device d on d.ID=a.DeviceID
            left join t_site s on s.ID=d.siteID
        
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <if test="siteID != null">
                AND s.ID in (#{siteID})
            </if>
            <if test="deviceID != null">
                AND d.ID in (#{deviceID})
            </if>
            <if test="status != null">
                AND d.ID in (#{status}) 
            </if>
            <if test="startDate != null">
                AND a.StartTime &gt;= #{startDate} 
            </if>
            <if test="endDate != null">
                AND a.StartTime &lt;= #{endDate} 
            </if>
            <if test="keywords != null">
                AND (
                    s.SiteName LIKE "%"#{keywords}"%"
                    or d.DeviceName LIKE "%"#{keywords}"%"
                    or a.Device_MAC LIKE "%"#{keywords}"%"
                    or a.AP_MAC LIKE "%"#{keywords}"%"
                )
            </if>
        </trim>
        
        <choose>
            <when test="orderField !=null and orderField !=''">
                 ORDER BY ${orderField} <if test="orderDirection != null and orderDirection != ''">${orderDirection}</if>
            </when>
            <otherwise>
                 order by a.ID DESC
            </otherwise>
        </choose>
           
    </select>
    
    <select id="findNumberByCondition" resultType="Integer" parameterType="map">
        select count(0) as c 
        FROM apl_log a
            left join device d on d.ID=a.DeviceID
            left join t_site s on s.ID=d.siteID 
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <if test="siteID != null">
                AND s.ID in (#{siteID})
            </if>
            <if test="deviceID != null">
                AND d.ID in (#{deviceID})
            </if>
            <if test="status != null">
                AND d.ID in (#{status}) 
            </if>
            <if test="startDate != null">
                AND a.StartTime &gt;= #{startDate} 
            </if>
            <if test="endDate != null">
                AND a.StartTime &lt;= #{endDate} 
            </if>
            <if test="keywords != null">
                AND (
                    s.SiteName LIKE "%"#{keywords}"%"
                    or d.DeviceName LIKE "%"#{keywords}"%"
                    or a.Device_MAC LIKE "%"#{keywords}"%"
                    or a.AP_MAC LIKE "%"#{keywords}"%"
                )
            </if>
        </trim>
    </select>
</mapper>