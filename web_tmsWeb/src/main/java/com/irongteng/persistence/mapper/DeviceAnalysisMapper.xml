<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.irongteng.persistence.mapper.DeviceAnalysisMapper">
    
    <cache />
    
    <resultMap id="deviceAnalysisResult" type="DeviceAnalysis">
        <id property="id" jdbcType="INTEGER" column="DeviceID" />
        <result property="deviceName" jdbcType="VARCHAR" column="DeviceName" />
        <result property="siteID" jdbcType="INTEGER" column="SiteID"/>
        <result property="siteName" jdbcType="VARCHAR" column="SiteName" />
        <result property="intradayTotal" jdbcType="INTEGER" column="IntradayTotal" />
        <result property="yestodayTotal" jdbcType="INTEGER" column="YestodayTotal" />
        <result property="monthTotal" jdbcType="INTEGER" column="MonthTotal" />
        <result property="total" jdbcType="INTEGER" column="Total" />
    </resultMap>
    
    <sql id="Common_Column_List">
        d.DeviceName, d.ID as DeviceID, d.SiteID, s.SiteName, ifnull(a.IntradayTotal,0) as IntradayTotal, ifnull(a.YestodayTotal,0) as YestodayTotal, ifnull(a.MonthTotal, 0) as MonthTotal, ifnull(a.Total, 0) as Total 
    </sql>
    <sql id="Base_Column_List">
        DeviceID, sum(IntradayTotal) as IntradayTotal, sum(YestodayTotal) as YestodayTotal, sum(MonthTotal) as MonthTotal, sum(Total) as Total
    </sql>
    <sql id="Intraday_Column_List">
        DeviceID, count(0) as IntradayTotal, 0 as YestodayTotal, 0 as MonthTotal, 0 as Total
    </sql>
    <sql id="Yestoday_Column_List">
        DeviceID, 0 as IntradayTotal, count(0) as YestodayTotal, 0 as MonthTotal, 0 as Total
    </sql>
    <sql id="Month_Column_List">
        DeviceID, 0 as IntradayTotal, 0 as YestodayTotal, count(0) as MonthTotal, 0 as Total
    </sql>
    <sql id="Total_Column_List">
        DeviceID, 0 as IntradayTotal, 0 as YestodayTotal, 0 as MonthTotal, count(0) as Total
    </sql>
    
    <!-- 场所分析分页表查询 -->
    <select id="findPageBreakByCondition" parameterType="map" resultMap="deviceAnalysisResult">
        select 
            <include refid="Common_Column_List" />
        from device d 
            left join t_site s on d.SiteID=s.ID
            left join (
                select 
                    <include refid="Base_Column_List" />
                from (
                    select 
                        <include refid="Total_Column_List" />
                    from hpl_log
                    <trim prefix="WHERE" prefixOverrides="AND|OR">
                        <if test="deviceID != null">
                            AND DeviceID in (#{deviceID}) 
                        </if>
                    </trim>
                    group by DeviceID

                    union all
                    select 
                        <include refid="Intraday_Column_List" />
                    from hpl_log
                    where to_days(RecordTime) = to_days(now())
                    <if test="deviceID != null">
                        AND DeviceID in (#{deviceID})
                    </if>
                    group by DeviceID

                    union all
                    select 
                        <include refid="Yestoday_Column_List" />
                    from hpl_log 
                    where TO_DAYS(NOW( )) - TO_DAYS(RecordTime) = 1 
                    <if test="deviceID != null">
                        AND DeviceID in (#{deviceID})
                    </if>
                    group by DeviceID

                    union all
                    select 
                        <include refid="Month_Column_List" />
                    from hpl_log
                    where DATE_FORMAT(RecordTime, '%Y%m') = DATE_FORMAT(CURDATE(), '%Y%m')
                    <if test="deviceID != null">
                        AND DeviceID in (#{deviceID})
                    </if>
                    group by DeviceID

                    <if test="type == null or (type!=null and type == 1)">
                        union all
                        select 
                            <include refid="Total_Column_List" />
                        from visit_log
                        <trim prefix="WHERE" prefixOverrides="AND|OR">
                           <if test="deviceID != null">
                                AND DeviceID in (#{deviceID})
                            </if>
                        </trim>
                        group by DeviceID

                        union all
                        select 
                            <include refid="Intraday_Column_List" />
                        from visit_log
                        where to_days(StartTime) = to_days(now())
                        <if test="deviceID != null">
                            AND DeviceID in (#{deviceID})
                        </if>
                        group by DeviceID

                        union all
                        select 
                            <include refid="Yestoday_Column_List" />
                        from visit_log 
                        where TO_DAYS(NOW()) - TO_DAYS(StartTime) = 1 
                        <if test="deviceID != null">
                            AND DeviceID in (#{deviceID})
                        </if>
                        group by DeviceID

                        union all
                        select 
                            <include refid="Month_Column_List" />
                        from visit_log
                        where DATE_FORMAT(StartTime, '%Y%m') = DATE_FORMAT(CURDATE(), '%Y%m')
                        <if test="deviceID != null">
                            AND DeviceID in (#{deviceID})
                        </if>
                        group by DeviceID
                    </if>
                ) b group by b.DeviceID
            ) a on a.DeviceID=d.ID
        where d.status=1
        <choose>
            <when  test="deviceID != null">
                AND d.ID in (#{deviceID})
            </when>
            <when test="type!=null and type != 1">
                and d.CategoryID=1
            </when>
        </choose>
        <if test="siteID != null">
            AND s.ID in (#{siteID}) 
        </if>
        <if test="keywords != null">
            AND (d.DeviceName LIKE "%"#{keywords}"%"
                or s.SiteName LIKE "%"#{keywords}"%"
            )
        </if>
        <choose>
            <when test="orderField !=null and orderField !=''">
                 ORDER BY ${orderField} <if test="orderDirection != null and orderDirection != ''">${orderDirection}</if>
            </when>
            <otherwise>
                 order by IntradayTotal desc
            </otherwise>
        </choose>
    </select>
    
    <!-- 查询符合条件总条数 -->
    <select id="findNumberByCondition" resultType="Integer" parameterType="map">
        select count(0) as num from device d
            left join t_site s on d.SiteID=s.ID
        where d.status=1
        <choose>
            <when  test="deviceID != null">
                AND d.ID in (#{deviceID})
            </when>
            <when test="type!=null and type != 1">
                and d.CategoryID=1
            </when>
        </choose>
        <if test="siteID != null">
            AND s.ID in (#{siteID}) 
        </if>
        <if test="keywords != null">
            AND (d.DeviceName LIKE "%"#{keywords}"%"
                or s.SiteName LIKE "%"#{keywords}"%"
            )
        </if>
    </select>
    
</mapper>