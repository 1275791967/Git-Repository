<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="com.irongteng.persistence.mapper.ParameterValueMapper">
    
    <cache />
    
    <!-- 设备信息表 -->
    <resultMap id="deviceResult" type="Device">
        <id property="id" jdbcType="INTEGER" column="DeviceID" />
        <result property="deviceName" jdbcType="VARCHAR" column="DeviceName" />
        <result property="deviceNumber" jdbcType="VARCHAR" column="DeviceNumber" />
        <result property="attachNumber" jdbcType="VARCHAR" column="Device_MAC" />
        <result property="longitude" jdbcType="DOUBLE" column="Longitude" />
        <result property="latitude" jdbcType="DOUBLE" column="Latitude" />
        <result property="commCategory" jdbcType="INTEGER" column="CommCategory" />
        <result property="ipAddress" jdbcType="VARCHAR" column="IpAddress" />
        <result property="port" jdbcType="INTEGER" column="Port" />
        <result property="address" jdbcType="VARCHAR" column="Address" />
        <result property="status" jdbcType="INTEGER" column="Status" />
        <result property="remark" jdbcType="VARCHAR" column="Remark" />
        <association property="category" javaType="Category" column="CategoryID" resultMap="categoryResult" />
    </resultMap>
    
    <!-- 所有参数表 -->
    <resultMap id="parameterResult" type="Parameter">
        <id property="id" jdbcType="INTEGER" column="ParameterID" />
        <result property="identifier" jdbcType="VARCHAR" column="Identifier" />
        <result property="paramName" jdbcType="VARCHAR" column="ParamName" />
        <result property="paramCategory" jdbcType="INTEGER" column="ParamCategory"/>
        <result property="paramAttribute" jdbcType="INTEGER" column="ParamAttribute"/>
        <result property="unit" jdbcType="VARCHAR" column="Unit" />
        <result property="valueType" jdbcType="VARCHAR" column="ValueType" />
        <result property="valueLength" jdbcType="INTEGER" column="ValueLength"/>
        <result property="valueMin" jdbcType="VARCHAR" column="ValueMin" />
        <result property="valueMax" jdbcType="VARCHAR" column="ValueMax" />
        <result property="valueMapper" jdbcType="VARCHAR" column="ValueMapper" />
        <result property="remark" jdbcType="VARCHAR" column="Remark" />
    </resultMap>
    
    <resultMap id="categoryResult" type="Category">
        <id property="id" jdbcType="INTEGER" column="CategoryID" />
        <result property="categoryName" jdbcType="VARCHAR" column="CategoryName" />
        <result property="protocolID" jdbcType="INTEGER" column="protocolID" />
        <result property="remark" jdbcType="VARCHAR" column="Remark" />
    </resultMap>
    
    <resultMap id="categoryParameterResult" type="CategoryParameter">
        <id property="id" jdbcType="INTEGER" column="CategoryParameterID" />
        <result property="remark" jdbcType="VARCHAR" column="Remark" />
        <association property="parameter" javaType="Parameter" column="Identifier" resultMap="parameterResult" />
        <association property="category" javaType="Category" column="CategoryID" resultMap="categoryResult" />
    </resultMap>
    
    <resultMap id="parameterValueResult" type="ParameterValue">
        <id property="id" jdbcType="INTEGER" column="ID" />
        <result property="value" jdbcType="VARCHAR" column="Value" />
        <result property="modifyDate" jdbcType="TIMESTAMP" column="ModifyDate" />
        <association property="device" javaType="Device" column="DeviceID" resultMap="deviceResult" />
        <association property="categoryParameter" javaType="CategoryParameter" column="CategoryParameterID" resultMap="categoryParameterResult" />
    </resultMap>
    
    <sql id="Base_Column_List">
        pv.ID, pv.CategoryParameterID, pv.DeviceID, pv.Value, pv.ModifyDate,d.DeviceNumber,d.AttachNumber, cp.CategoryID,
            p.Identifier,p.ParamName,p.ParamCategory,p.ParamAttribute,p.Unit,p.ValueType,p.ValueLength,p.ValueMapper
    </sql>
    
    <sql id="Simple_Column_List">
        pv.ID, pv.CategoryParameterID, pv.DeviceID, pv.Value, pv.ModifyDate,d.DeviceNumber,d.AttachNumber, cp.CategoryID,
            p.Identifier,p.ParamName,p.ParamCategory,p.ParamAttribute,p.Unit,p.ValueType,p.ValueLength,p.ValueMapper
    </sql>
    
    <select id="load" parameterType="Integer" resultMap="parameterValueResult">
        SELECT 
            <include refid="Base_Column_List" />
        FROM parametervalue 
        WHERE 
            ID = #{id} 
    </select>
    
    <!-- 根据设备ID和参数identifier查找参数值与参数相关信息 -->
    <select id="queryIdentifier" parameterType="map" resultMap="parameterValueResult">
        select 
            <include refid="Base_Column_List" />
        from parametervalue pv
            inner join device d on pv.DeviceID = d.ID
            inner join categoryparameter cp on cp.CategoryID = d.CategoryID and cp.ID=pv.CategoryParameterID
            inner join parameter p on p.Identifier=cp.Identifier
        where 
            d.ID = #{deviceID}
            and p.Identifier= #{identifier}
    </select>
    <!-- 根据设备ID和参数identifier查找参数值与参数相关信息 -->
    <select id="searchByIdentifiers" parameterType="map" resultMap="parameterValueResult">
        select 
            <include refid="Base_Column_List" />
        from parametervalue pv
            inner join device d on pv.DeviceID = d.ID
            inner join categoryparameter cp on cp.CategoryID = d.CategoryID and cp.ID=pv.CategoryParameterID
            inner join parameter p on p.Identifier=cp.Identifier
        where 
            d.ID = #{deviceID}
            <choose>
                <when test="identifierList.size() > 0"> 
                    and p.Identifier in
                    <foreach collection="identifierList" item="item" open="(" separator="," close=")">
                    #{item}  
                    </foreach>
                </when>
                <otherwise>
                    and p.Identifier=""
                </otherwise>
            </choose>
    </select>
    
    <!-- 根据设备ID查找参数值与参数相关信息 -->
    <select id="findByDeviceID" parameterType="Integer" resultMap="parameterValueResult">
        select 
            <include refid="Simple_Column_List" />
        from parametervalue pv
            inner join device d on pv.DeviceID = d.ID
            inner join categoryparameter cp on cp.CategoryID = d.CategoryID and cp.ID=pv.CategoryParameterID
            inner join parameter p on p.Identifier=cp.Identifier
        where 
            d.ID = #{deviceID}
    </select>
    
    
    <!-- 根据设备ID查找参数值与参数相关信息 -->
    <select id="findByParamCategory" parameterType="Integer" resultMap="parameterValueResult">
        select 
            <include refid="Simple_Column_List" />
        from parametervalue pv
            inner join device d on pv.DeviceID = d.ID
            inner join categoryparameter cp on cp.CategoryID = d.CategoryID and cp.ID=pv.CategoryParameterID
            inner join parameter p on p.Identifier=cp.Identifier
        where 
            d.ID = #{deviceID} and p.ParamCategory= #{paramCategory}
    </select>
    
    <!-- 判断参数DeviceID和CategoryParameterID联合主键是否存在 -->
    <select id="isExistParamValue" parameterType="map" resultType="Integer">
        select count(0) as c
        from parametervalue 
        where DeviceID = #{deviceID} 
            and CategoryParameterID = #{categoryParameterID}
    </select>
    
    <!-- 判断DeviceID是否存在 -->
    <select id="isExistDevice" parameterType="map" resultType="Integer">
        select count(0) as c
        from parametervalue 
        where DeviceID = #{deviceID}
    </select>
    
    <!-- 插入 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO parametervalue (
            CategoryParameterID,
            DeviceID,
            Value,
            modifyDate
        ) VALUES (
            #{categoryParameter.id},
            #{device.id},
            #{value},
            #{modifyDate}
        )
    </insert>
    
    <!-- 批量插入 -->
    <insert id="addBatch" parameterType="java.util.List">
        insert into parametervalue(
            CategoryParameterID,
            DeviceID,
            Value,
            ModifyDate
        )
        values  
        <foreach item="item" index="index" collection="list" separator=",">
            (
            #{item.categoryParameter.id},
            #{item.device.id},
            #{item.value},
            #{item.modifyDate}
            )
        </foreach>  
    </insert>
    
    <!-- 批量插入 -->
    <insert id="addBatchByDeviceID" parameterType="Integer">
        insert into parametervalue(CategoryParameterID, DeviceID)
        select cp.ID as CategoryParameterID, d.ID as DeviceID
        from device d
            inner join categoryparameter cp on cp.CategoryID = d.CategoryID
        where 
            d.id = #{deviceID}; 
    </insert>
    
    <!-- 更新 -->
    <update id="update" parameterType="ParameterValue">
        UPDATE parametervalue SET
            Value=#{value},
            ModifyDate=#{modifyDate}
        where 
            ID = #{id}
    </update>
    
    <!-- 按条件更新 -->
    <update id="updateSelective" parameterType="ParameterValue">
        UPDATE parametervalue 
        <set>
            <if test="value!=null">
            Value = #{value},
            </if>
            <if test="modifyDate!=null">
            ModifyDate=#{modifyDate},
            </if>
        </set>
        WHERE
            ID = #{id}
    </update>
    
    <!-- 按条件批量更新 -->
    <update id="updateBatchSelective" parameterType="java.util.List">
        <foreach item="item" collection="list" index="index" open="" close="" separator=";">
            update parametervalue pv, categoryparameter cp, device d 
            <set>
                <if test="item.value!=null">
                pv.Value = #{item.value},
                </if>
                <if test="item.modifyDate!=null">
                pv.ModifyDate=#{item.modifyDate},
                </if>
            </set>
            where pv.DeviceID = d.ID 
                and cp.CategoryID = d.CategoryID 
                and cp.ID=pv.CategoryParameterID 
            <choose>
                <when test="item.categoryParameter!=null and item.categoryParameter.parameter!=null and item.device!=null">
                    <if test="item.categoryParameter.parameter.id !=null">
                        and cp.ID=#{item.categoryParameter.parameter.id}
                    </if>
                    <if test="item.categoryParameter.parameter.identifier !=null">
                        and cp.Identifier=#{item.categoryParameter.parameter.identifier}
                    </if>
                    
                    <if test="item.device.id !=null">
                        and d.ID=#{item.device.id}
                    </if>
                    <if test="item.device.siteNumber != null">
                        and d.SiteNumber=#{item.device.siteNumber}
                    </if>
                    <if test="item.device.deviceNumber !=null">
                        and d.DeviceNumber=#{item.device.deviceNumber}
                    </if>
                    <if test="item.device.attachNumber !=null">
                        and d.AttachNumber=#{item.device.attachNumber}
                    </if>
                </when>
                <otherwise>
                    <choose>
                        <when test="item.id != null">
                            and pv.ID = #{item.id}
                        </when>
                        <otherwise>
                            and pv.ID = 0
                        </otherwise>
                    </choose>
                </otherwise>
            </choose>
          </foreach>
    </update>
    
    <!-- 按Id删除 -->
    <delete id="delete" parameterType="Integer">
        DELETE FROM parametervalue WHERE
        ID = #{id}
    </delete>
    
    <!-- 按设备编号或属性编号可选择删除 -->
    <delete id="deleteSelective" parameterType="ParameterValue">
        DELETE FROM parametervalue 
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <if test="id !=null">
                and ID = #{id}
            </if>
            <if test="categoryParameter!=null and categoryParameter.parameter!=null and categoryParameter.parameter.id!=null">
                and CategoryParameterID = #{id}
            </if>
            <!-- 根据设备ID删除 -->
            <if test="device!=null and device.id!=null">
                and DeviceID=#{device.id}
            </if>
            <!-- 根据设备编号或者属性编号删除 -->
            <choose>
                <when test="device!=null and (device.deviceNumber !=null or device.attachNumber !=null)">
                    and DeviceID in (select d.ID from device d
                    <trim prefix="WHERE" prefixOverrides="AND|OR">
                        <if test="device.deviceNumber!=null">
                            and d.DeviceNumber=#{device.deviceNumber}
                        </if>
                        <if test="device.attachNumber!=null">
                            and d.AttachNumber=#{device.attachNumber}
                        </if>
                    </trim>
                    )
                </when>
            </choose>
            <!-- 根据参数ID参数 -->
            <if test="categoryParameter!=null and categoryParameter.parameter!=null and categoryParameter.parameter.identifier!=null">
                and CategoryParameterID in (select cp.ID from categoryParameter cp 
                    WHERE cp.Identifier=#{categoryParameter.parameter.identifier}
                )
            </if>
            <!-- 根据设备类型删除 -->
            <if test="categoryParameter!=null and categoryParameter.category!=null and categoryParameter.category.id!=null">
                and CategoryParameterID in (
                    select cp.ID 
                    from categoryParameter cp 
                        inner join category c on cp.CategoryID=c.ID
                    WHERE c.Identifier=#{categoryParameter.category.id}
                )
            </if>
        </trim>
    </delete>
    
    <!-- 按设备DeviceID删除 -->
    <delete id="deleteByDeviceID" parameterType="Integer">
        DELETE FROM parametervalue WHERE
        DeviceID = #{deviceID} 
    </delete>
    
    <!-- 批量删除 -->
    <delete id="deleteBatch" parameterType="java.util.List">
        DELETE FROM parametervalue WHERE
        ID in
        <foreach collection="list" item = "item" open="(" separator="," close=")">
        #{item}  
        </foreach>
    </delete>
    
    <!-- 指定页查询 -->
    <select id="findPageBreakByCondition" resultMap="parameterValueResult" parameterType="map">
        SELECT 
            <include refid="Base_Column_List" />
        from parametervalue pv
            inner join device d on pv.DeviceID = d.ID
            inner join categoryparameter cp on cp.CategoryID = d.CategoryID and cp.ID=pv.CategoryParameterID
            inner join parameter p on p.Identifier=cp.Identifier
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <if test="status != null">
                AND d.id=#{status} 
            </if>
            <if test="type != null">
                AND p.Identifier=#{type} 
            </if>
            <if test="keywords != null">
                AND (p.Identifier LIKE "%"#{keywords}"%"
                    or p.ParamName LIKE "%"#{keywords}"%"
                )
              </if>
        </trim>
        
        <choose>
            <when test="orderField !=null and orderField !=''">
                ORDER BY ${orderField} <if test="orderDirection != null and orderDirection != ''">${orderDirection}</if>
            </when>
            <otherwise>
                order by pv.ID
            </otherwise>
        </choose>
           
    </select>
    
    <!-- 指定页查询总条数 -->
    <select id="findNumberByCondition" resultType="Integer" parameterType="map">
        select count(0) as c 
        from parametervalue pv
            inner join device d on pv.DeviceID = d.ID
            inner join categoryparameter cp on cp.CategoryID = d.CategoryID and cp.ID=pv.CategoryParameterID
            inner join parameter p on p.Identifier=cp.Identifier
        
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <if test="status != null">
                AND d.id=#{status} 
            </if>
            <if test="type != null">
                AND p.Identifier=#{type} 
            </if>
            <if test="keywords != null">
                AND (p.Identifier LIKE "%"#{keywords}"%"
                    or p.ParamName LIKE "%"#{keywords}"%"
                )
            </if>
        </trim>
        
    </select>
</mapper>